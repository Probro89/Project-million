<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <style>
        header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
    }

    .nav-buttons {
        display: flex;
        gap: 10px;
    }

    .profile-btn {
        background-color: #2196F3;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }
        .task-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .scores {
            display: flex;
            justify-content: space-between;
            margin: 20px;
        }
        .pass-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .fail-btn {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Welcome to Your Space</h1>
        <div class="nav-buttons">
            <button onclick="window.location.href='../signup/login/user_pairing/pairing.html'">Pairing Page</button>
            <button class="profile-btn" onclick="window.location.href='profile.html'">
                ðŸ‘¤ Profile
            </button>
        </div>
    </header>

    <main>
        <div class="scores">
            <div>Your Score: <span id="userScore">0</span></div>
            <div>Partner's Score: <span id="partnerScore">0</span></div>
            <div>Combined Score: <span id="combinedScore">0</span></div>
        </div>

        <section id="taskSection" class="task-container">
            <h2>Current Task</h2>
            <div id="currentTask">
                <p>Loading task...</p>
            </div>
        </section>

        <section id="pairedUserInfo">
            <h2>Your Paired User</h2>
            <div id="pairedUserDetails">
                <p>Loading paired user information...</p>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDuwbFf4v05VzuNu84YCS9S31pV9cOYktw",
            authDomain: "ocean-35959.firebaseapp.com",
            projectId: "ocean-35959",
            storageBucket: "ocean-35959.firebasestorage.app",
            messagingSenderId: "926712216319",
            appId: "1:926712216319:web:ac2a5ffc6fb5b56447eaca",
            measurementId: "G-J844DFXM0W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        async function getRandomTask() {
            const tasksRef = ref(db, 'tasks');
            const tasksSnapshot = await get(tasksRef);
            const tasks = tasksSnapshot.val();

            const lists = Object.keys(tasks);
            const randomList = lists[Math.floor(Math.random() * lists.length)];
            const taskList = tasks[randomList];
            const randomTask = taskList[Math.floor(Math.random() * taskList.length)];
            
            const points = {
                list1: 2,
                list2: 4,
                list3: 6,
                list4: 10
            };

            return {
                task: randomTask,
                points: points[randomList]
            };
        }

        async function displayNewTask() {
            try {
                const taskData = await getRandomTask();
                const taskDiv = document.getElementById("currentTask");
                taskDiv.innerHTML = `
                    <p>${taskData.task}</p>
                    <p>Worth ${taskData.points} points</p>
                    <div>
                        <button class="pass-btn" onclick="handleTaskCompletion(true, ${taskData.points})">Pass</button>
                        <button class="fail-btn" onclick="handleTaskCompletion(false, ${taskData.points})">Fail</button>
                    </div>
                `;
            } catch (error) {
                console.error("Error displaying task:", error);
                document.getElementById("currentTask").innerHTML = "<p>Error loading task. Please try again.</p>";
            }
        }

        async function updateScores(userId, pairedUserId) {
            const userRef = ref(db, `users/${userId}`);
            const pairedUserRef = ref(db, `users/${pairedUserId}`);
            
            const [userSnapshot, pairedSnapshot] = await Promise.all([
                get(userRef),
                get(pairedUserRef)
            ]);

            const userScore = userSnapshot.val().score || 0;
            const partnerScore = pairedSnapshot.val().score || 0;
            const combinedScore = userScore + partnerScore;

            document.getElementById('userScore').textContent = userScore;
            document.getElementById('partnerScore').textContent = partnerScore;
            document.getElementById('combinedScore').textContent = combinedScore;
        }

        window.handleTaskCompletion = async function(passed, points) {
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(db, `users/${user.uid}`);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            if (passed) {
                const currentScore = userData.score || 0;
                await update(userRef, {
                    score: currentScore + points
                });

                if (userData.pairedWith) {
                    await updateScores(user.uid, userData.pairedWith);
                }
            }

            displayNewTask();
        }

        onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userRef = ref(db, `users/${user.uid}`);
        try {
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();

            if (userData) {
                if (userData.pairedWith) {
                    await updateScores(user.uid, userData.pairedWith);
                    await displayPairedUserInfo(userData.pairedWith); // Fetch and display paired user info
                } else {
                    document.getElementById("pairedUserDetails").innerHTML = "<p>No paired user found.</p>";
                }
            }
            await displayNewTask(); // Ensure task fetching always happens after authentication
        } catch (error) {
            console.error("Error fetching user data:", error);
            document.getElementById("currentTask").innerHTML = "<p>Error loading data. Please try again later.</p>";
        }
    } else {
        document.getElementById("currentTask").innerHTML = "<p>Please log in to view tasks.</p>";
        document.getElementById("pairedUserDetails").innerHTML = "<p>Please log in to view your paired user.</p>";
    }
});

// Define displayPairedUserInfo function here to ensure it is available
async function displayPairedUserInfo(pairedUserId) {
    const pairedUserRef = ref(db, `users/${pairedUserId}`);
    try {
        const snapshot = await get(pairedUserRef);
        const pairedUserData = snapshot.val();

        if (pairedUserData) {
            document.getElementById("pairedUserDetails").innerHTML = `
                <p><strong>Username:</strong> ${pairedUserData.username || 'Not set'}</p>
                <p><strong>Score:</strong> ${pairedUserData.score || 0}</p>
                <p><strong>Status:</strong> ${pairedUserData.online ? 'Online' : 'Offline'}</p>
            `;
        } else {
            document.getElementById("pairedUserDetails").innerHTML = "<p>No paired user found.</p>";
        }
    } catch (error) {
        console.error("Error fetching paired user info:", error);
        document.getElementById("pairedUserDetails").innerHTML = "<p>Error loading paired user information.</p>";
    }
}


    </script>
</body>
</html>